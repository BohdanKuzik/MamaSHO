{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - {{ site_name }}{% endblock %}
{% block meta_description %}{{ product.description|default:default_description|truncatewords:25 }}{% endblock %}
{% block meta_keywords %}{{ product.category.name }}, {{ product.name }}, дитячі товари, {{ default_keywords }}{% endblock %}
{% block canonical_url %}{{ site_url }}{% url 'product_detail' pk=product.pk %}{% endblock %}
{% block og_type %}product{% endblock %}
{% block og_url %}{{ site_url }}{% url 'product_detail' pk=product.pk %}{% endblock %}
{% block og_title %}{{ product.name }} - {{ site_name }}{% endblock %}
{% block og_description %}{{ product.description|default:default_description|truncatewords:25 }}{% endblock %}
{% block og_image %}{% if primary_gallery_image %}{{ primary_gallery_image.absolute_url }}{% else %}{{ site_url }}{% static 'images/logo.png' %}{% endif %}{% endblock %}
{% block twitter_title %}{{ product.name }} - {{ site_name }}{% endblock %}
{% block twitter_description %}{{ product.description|default:default_description|truncatewords:25 }}{% endblock %}
{% block twitter_image %}{% if primary_gallery_image %}{{ primary_gallery_image.absolute_url }}{% else %}{{ site_url }}{% static 'images/logo.png' %}{% endif %}{% endblock %}
{% block twitter_url %}{{ site_url }}{% url 'product_detail' pk=product.pk %}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        {# Breadcrumbs для SEO #}
        <nav aria-label="Breadcrumb" class="mb-4">
            <ol class="flex items-center gap-2 text-sm text-base-content/70">
                <li><a href="{% url 'product_list' %}" class="hover:text-primary transition-colors">Головна</a></li>
                <li><span>/</span></li>
                <li><a href="{% url 'product_list' %}" class="hover:text-primary transition-colors">Каталог</a></li>
                <li><span>/</span></li>
                <li><a href="{% url 'product_list' %}?category={{ product.category.id }}" class="hover:text-primary transition-colors">{{ product.category.name }}</a></li>
                <li><span>/</span></li>
                <li class="text-base-content">{{ product.name|truncatewords:5 }}</li>
            </ol>
        </nav>
        
        {# Breadcrumbs Schema.org #}
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "Головна",
                    "item": "{{ site_url }}{% url 'product_list' %}"
                },
                {
                    "@type": "ListItem",
                    "position": 2,
                    "name": "Каталог",
                    "item": "{{ site_url }}{% url 'product_list' %}"
                },
                {
                    "@type": "ListItem",
                    "position": 3,
                    "name": "{{ product.category.name|escapejs }}",
                    "item": "{{ site_url }}{% url 'product_list' %}?category={{ product.category.id }}"
                },
                {
                    "@type": "ListItem",
                    "position": 4,
                    "name": "{{ product.name|escapejs }}",
                    "item": "{{ site_url }}{% url 'product_detail' pk=product.pk %}"
                }
            ]
        }
        </script>
        
        <div class="mb-6">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-base-content break-words mb-4" style="word-break: break-word; overflow-wrap: anywhere;">{{ product.name }}</h1>
        </div>
        
        {# Schema.org Structured Data для продукту #}
        <script type="application/ld+json">
        {
            "@context": "https://schema.org/",
            "@type": "Product",
            "name": "{{ product.name|escapejs }}",
            "description": "{{ product.description|default:default_description|escapejs|truncatewords:50 }}",
            "image": [
                {% if gallery_images %}
                    {% for image in gallery_images %}"{{ image.absolute_url }}"{% if not forloop.last %},{% endif %}{% endfor %}
                {% else %}
                    "{{ site_url }}{% static 'images/logo.png' %}"
                {% endif %}
            ],
            "brand": {
                "@type": "Brand",
                "name": "{{ site_name }}"
            },
            "offers": {
                "@type": "Offer",
                "url": "{{ site_url }}{% url 'product_detail' pk=product.pk %}",
                "priceCurrency": "UAH",
                "price": "{{ product.price }}",
                "priceValidUntil": "2025-12-31",
                "availability": "{% if product.available and product.stock > 0 %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
                "itemCondition": "https://schema.org/NewCondition"
            },
            "category": "{{ product.category.name|escapejs }}",
            "sku": "{{ product.pk }}"
        }
        </script>
        
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="grid md:grid-cols-2 gap-6">
                    <div x-data="{
                        images: [
                            {% for image in gallery_images %}
                                { 
                                    url: '{{ image.url }}', 
                                    thumb: '{{ image.thumb }}',
                                    alt: '{{ image.alt|escapejs }}',
                                    width: {{ image.width }},
                                    height: {{ image.height }}
                                }{% if not forloop.last %},{% endif %}
                            {% endfor %}
                        ].filter(img => img?.url),
                        currentIndex: 0,
                        touchStartX: 0,
                        touchStartY: 0,
                        touchEndX: 0,
                        touchEndY: 0,
                        minSwipeDistance: 50,
                        handleTouchStart(e) {
                            this.touchStartX = e.touches[0].clientX;
                            this.touchStartY = e.touches[0].clientY;
                        },
                        handleTouchMove(e) {
                            this.touchEndX = e.touches[0].clientX;
                            this.touchEndY = e.touches[0].clientY;
                        },
                        handleTouchEnd() {
                            if (!this.touchStartX || !this.touchEndX) return;
                            const deltaX = this.touchStartX - this.touchEndX;
                            const deltaY = this.touchStartY - this.touchEndY;
                            const absDeltaX = Math.abs(deltaX);
                            const absDeltaY = Math.abs(deltaY);
                            
                            // Only trigger swipe if horizontal movement is greater than vertical (to avoid conflicts with scrolling)
                            if (absDeltaX > absDeltaY && absDeltaX > this.minSwipeDistance) {
                                if (deltaX > 0) {
                                    // Swipe left - next image
                                    this.nextImage();
                            } else {
                                    // Swipe right - previous image
                                    this.prevImage();
                                }
                            }
                            // Reset touch coordinates
                            this.touchStartX = 0;
                            this.touchEndX = 0;
                            this.touchStartY = 0;
                            this.touchEndY = 0;
                        },
                        openModal(index = 0) {
                            this.currentIndex = index;
                            if (this.$refs.imageModal && typeof this.$refs.imageModal.showModal === 'function') {
                                this.$refs.imageModal.showModal();
                                document.documentElement.classList.add('overflow-hidden');
                            }
                        },
                        closeModal() {
                            if (this.$refs.imageModal && this.$refs.imageModal.open) {
                                this.$refs.imageModal.close();
                                document.documentElement.classList.remove('overflow-hidden');
                            }
                        },
                        nextImage() {
                            if (!this.images.length) return;
                            this.currentIndex = (this.currentIndex + 1) % this.images.length;
                        },
                        prevImage() {
                            if (!this.images.length) return;
                            this.currentIndex = (this.currentIndex - 1 + this.images.length) % this.images.length;
                        },
                        get currentImage() {
                            return this.images[this.currentIndex] || null;
                        }
                    }"
                    @keydown.window.prevent="if($refs.imageModal?.open){ 
                        if($event.key === 'ArrowRight') nextImage(); 
                        if($event.key === 'ArrowLeft') prevImage(); 
                        if($event.key === 'Escape') closeModal();
                    }">
                        {% if gallery_images %}
                            <div>
                                <figure class="rounded-lg overflow-hidden bg-base-200 relative"
                                        @touchstart="handleTouchStart($event)"
                                        @touchmove="handleTouchMove($event)"
                                        @touchend="handleTouchEnd()">
                                    <template x-if="images.length">
                                        <img :src="currentImage?.url" 
                                             :alt="currentImage?.alt" 
                                             :width="currentImage?.width"
                                             :height="currentImage?.height"
                                             loading="eager"
                                             decoding="async"
                                             class="w-full h-auto object-cover min-h-[18rem] max-h-[30rem] md:max-h-[36rem] cursor-pointer hover:scale-[1.01] transition-transform duration-200"
                                             @click="openModal(currentIndex)"
                                             x-transition:enter="transition ease-out duration-300"
                                             x-transition:enter-start="opacity-0"
                                             x-transition:enter-end="opacity-100"
                                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\'%3E%3Cpath fill=\'%23e5e7eb\' d=\'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\'/%3E%3C/svg%3E';">
                                    </template>
                                    <template x-if="!images.length">
                                        <div class="bg-base-200 rounded-lg flex items-center justify-center h-64">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-base-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                    </template>
                                    <template x-if="images.length > 1">
                                        <div class="absolute inset-y-0 left-0 right-0 flex items-center justify-between px-2 sm:px-4 pointer-events-none">
                                            <button type="button" 
                                                    class="pointer-events-auto rounded-full p-1.5 sm:p-2 border border-white/40 transition-all hover:bg-white/40 shadow-lg"
                                                    @click.stop="prevImage()"
                                                    style="background-color: rgba(255, 255, 255, 0.25); backdrop-filter: blur(6px);">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="stroke: rgba(0, 0, 0, 0.8);">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                                </svg>
                                            </button>
                                            <button type="button" 
                                                    class="pointer-events-auto rounded-full p-1.5 sm:p-2 border border-white/40 transition-all hover:bg-white/40 shadow-lg"
                                                    @click.stop="nextImage()"
                                                    style="background-color: rgba(255, 255, 255, 0.25); backdrop-filter: blur(6px);">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="stroke: rgba(0, 0, 0, 0.8);">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                    <template x-if="images.length > 1">
                                        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 px-3 py-1 rounded-full text-xs sm:text-sm font-semibold shadow-lg backdrop-blur-sm"
                                             style="background-color: rgba(255, 255, 255, 0.25); color: rgba(0, 0, 0, 0.75);">
                                            <span x-text="currentIndex + 1"></span> / <span x-text="images.length"></span>
                                        </div>
                                    </template>
                                </figure>
                                {% if gallery_images %}
                                    <div class="flex gap-2 mt-4 overflow-x-auto pb-2">
                                        {% for image in gallery_images %}
                                            <button @click="currentIndex = {{ forloop.counter0 }}; openModal(currentIndex)"
                                                    :class="currentIndex === {{ forloop.counter0 }} ? 'border-primary' : 'border-transparent'"
                                                    class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 hover:border-primary/60 transition-all">
                                                <img src="{{ image.thumb }}" 
                                                     alt="{{ image.alt }}" 
                                                     loading="lazy" 
                                                     decoding="async"
                                                     width="{{ image.thumb_width }}"
                                                     height="{{ image.thumb_height }}"
                                                     class="w-full h-full object-cover">
                                            </button>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="bg-base-200 rounded-lg flex items-center justify-center h-64">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-base-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                        {% endif %}

                        <dialog x-ref="imageModal" class="modal">
                            <div class="modal-box w-11/12 max-w-4xl max-h-[85vh] overflow-y-auto">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="text-sm font-semibold text-base-content/70">
                                        <span x-text="images.length ? currentIndex + 1 : 0"></span> / <span x-text="images.length"></span>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-circle btn-ghost" @click="closeModal()">✕</button>
                                </div>
                                <div class="relative flex items-center justify-center bg-base-200 rounded-lg min-h-[300px]"
                                     @touchstart="handleTouchStart($event)"
                                     @touchmove="handleTouchMove($event)"
                                     @touchend="handleTouchEnd()">
                                    <template x-if="images.length">
                                        <img :src="images[currentIndex]?.url"
                                             :alt="images[currentIndex]?.alt"
                                             class="max-h-[70vh] w-auto object-contain rounded-lg"
                                             x-transition:enter="transition ease-out duration-300"
                                             x-transition:enter-start="opacity-0 scale-95"
                                             x-transition:enter-end="opacity-100 scale-100">
                                    </template>
                                    <template x-if="images.length > 1">
                                        <div class="absolute inset-y-0 left-0 right-0 flex items-center justify-between px-2 sm:px-4 pointer-events-none">
                                            <button type="button" 
                                                    class="pointer-events-auto rounded-full p-1.5 sm:p-2 border border-white/30 transition-all hover:bg-white/40 shadow-lg"
                                                    @click.stop="prevImage()"
                                                    style="background-color: rgba(255, 255, 255, 0.25); backdrop-filter: blur(6px);">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="stroke: rgba(0, 0, 0, 0.8);">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                                </svg>
                                            </button>
                                            <button type="button" 
                                                    class="pointer-events-auto rounded-full p-1.5 sm:p-2 border border-white/30 transition-all hover:bg-white/40 shadow-lg"
                                                    @click.stop="nextImage()"
                                                    style="background-color: rgba(255, 255, 255, 0.25); backdrop-filter: blur(6px);">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="stroke: rgba(0, 0, 0, 0.8);">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <form method="dialog" class="modal-backdrop">
                                <button @click="closeModal()">close</button>
                            </form>
                        </dialog>
                    </div>
                    <div class="space-y-4">
                        <div class="stat bg-base-200 rounded-lg p-4">
                            <div class="stat-title">Категорія</div>
                            <div class="text-xl sm:text-2xl font-bold break-words" style="word-break: break-word; overflow-wrap: anywhere;">{{ product.category }}</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg p-4">
                            <div class="stat-title">Ціна</div>
                            <div class="stat-value text-2xl text-success">{{ product.price }}₴</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg p-4">
                            <div class="stat-title">На складі</div>
                            <div class="stat-value text-2xl {% if product.stock < 10 %}text-error{% else %}text-info{% endif %}">
                                {{ product.stock }} од.
                            </div>
                        </div>
                        {% if product.sizes.all %}
                        <div class="stat bg-base-200 rounded-lg p-4">
                            <div class="stat-title">Розміри (зріст)</div>
                            <div class="flex flex-wrap gap-2 mt-2">
                                {% for size in product.sizes.all %}
                                    <span class="badge badge-outline badge-lg">{{ size.get_value_display }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% if product.description %}
                <div class="mt-6 pt-6 border-t border-base-300">
                    <h3 class="text-xl font-bold mb-4 text-base-content">Опис товару</h3>
                    <div class="prose prose-sm max-w-none text-base-content">
                        <p class="whitespace-pre-line leading-relaxed">{{ product.description }}</p>
                    </div>
                </div>
                {% endif %}
                <div class="mt-6 pt-6 border-t border-base-300">
                    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                    {% if product.available and product.stock > 0 %}
                        <form method="post"
                              action="{% url 'basket_add' product_id=product.pk %}"
                              class="flex-1 w-full sm:w-auto"
                              id="add-to-basket-form"
                              x-data="{
                                  quantity: 1,
                                  normalize(value) {
                                      const parsed = parseInt(value, 10);
                                      return Number.isNaN(parsed) || parsed < 1 ? 1 : parsed;
                                  },
                                  update(value) {
                                      this.quantity = this.normalize(value);
                                      this.$refs.quantityInput.value = this.quantity;
                                  },
                                  change(delta) {
                                      this.update(this.quantity + delta);
                                  }
                              }">
                        {% csrf_token %}
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full">
                                <div class="flex items-center gap-3">
                                    <label for="quantity-input" class="label-text whitespace-nowrap font-semibold">
                                        Кількість:
                                    </label>
                                    <div class="flex items-center gap-2 bg-base-200 rounded-lg px-2 py-1 shadow-sm pointer-events-auto">
                                        <button type="button"
                                                class="btn btn-ghost btn-xs px-2"
                                                aria-label="Зменшити кількість"
                                                @click.prevent="change(-1)">
                                            −
                                        </button>
                                    <input type="number"
                                           name="quantity"
                                           value="1"
                                           min="1"
                                               x-ref="quantityInput"
                                               x-model.number="quantity"
                                               @input="update($event.target.value)"
                                               inputmode="numeric"
                                               pattern="[0-9]*"
                                               autocomplete="off"
                                               class="input input-bordered w-20 text-center font-semibold focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#f89886] pointer-events-auto"
                                               id="quantity-input">
                                        <button type="button"
                                                class="btn btn-ghost btn-xs px-2"
                                                aria-label="Збільшити кількість"
                                                @click.prevent="change(1)">
                                            +
                                        </button>
                                    </div>
                                </div>
                            <button type="button" 
                                        class="btn btn-primary flex-1 sm:flex-none whitespace-nowrap"
                                    hx-post="{% url 'basket_add' product_id=product.pk %}"
                                    hx-include="#add-to-basket-form"
                                    hx-target="body"
                                    hx-swap="none"
                                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                    hx-on::after-request="
                                        const triggerHeader = event.detail.xhr.getResponseHeader('HX-Trigger');
                                        if (triggerHeader) {
                                            try {
                                                const triggerPayload = JSON.parse(triggerHeader);
                                                const showToast = triggerPayload['show-toast'];
                                                if (showToast && showToast.type === 'warning') {
                                                    return;
                                                }
                                            } catch (err) {
                                                console.error('HX-Trigger parse error', err);
                                            }
                                        }
                                        if (event.detail.xhr.status === 200) {
                                            this.textContent = 'Додано!';
                                            setTimeout(() => {
                                                this.innerHTML = '<svg xmlns=\'http://www.w3.org/2000/svg\' class=\'h-5 w-5 mr-2\' fill=\'none\' viewBox=\'0 0 24 24\' stroke=\'currentColor\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z\' /></svg>Додати в кошик';
                                            }, 1000);
                                        }
                                    ">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                Додати в кошик
                            </button>
                        </div>
                    </form>
                    {% else %}
                        <button class="btn btn-primary w-full sm:w-auto" disabled>
                        Товар недоступний
                    </button>
                    {% endif %}
                        
                        {% if request.user.is_staff or request.user.is_superuser %}
                        <a href="{% url 'edit_product' pk=product.pk %}" class="btn btn-outline btn-primary w-full sm:w-auto flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            Редагувати товар
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
